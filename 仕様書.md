# 匿名掲示板システム「AnonBBS」機能要件仕様書

## 1. システム概要

### 1.1 システム名（仮）

匿名掲示板システム「AnonBBS」

### 1.2 目的

ユーザーが会員登録なしでスレッドを立てたり、匿名で書き込み・閲覧できる掲示板サービスを提供する。

### 1.3 対象ユーザー

- 不特定多数の一般ユーザー（閲覧・書き込み）
- 管理者（荒らし対策・規約違反対応、設定変更）

### 1.4 想定利用環境

- Web ブラウザ（PC / スマホ）からのアクセス
- 会員登録・ログイン機能は持たない

---

## 2. 画面一覧

1. トップページ（板一覧画面）
2. 板ページ（スレッド一覧画面）
3. スレッド詳細ページ（投稿一覧画面）
4. スレッド作成画面
5. 書き込みフォーム（レス投稿）
6. 検索結果画面
7. 管理者用ログイン画面
8. 管理者ダッシュボード
9. 管理者：スレッド／投稿管理画面
10. エラーページ（404 / 500 など）

---

## 3. 利用者機能要件（一般ユーザー）

### 3.1 匿名利用

- **FR-001**：ユーザーは、会員登録やログインを行わずにサイトを利用できること。
- **FR-002**：投稿時、ユーザー名は**固定の「名無しさん」**等の共通名、または任意入力のハンドルネームとする（どちらにするかは設定で決定可能）。
- **FR-003**：IP アドレスやホスト名など、個人が特定される情報は画面上には表示しないこと。
  - （内部的にはログとして保存してもよいが、一般ユーザーには見せない。）

### 3.2 板（カテゴリ）機能

- **FR-010**：掲示板は複数の「板」を持つこと（例：雑談板、ニュース板、趣味板 など）。
- **FR-011**：トップページで板一覧を表示すること。
  - 板名
  - 説明文
  - スレッド数または最新書き込み日時 などの簡易情報
- **FR-012**：板をクリックすると、その板に属するスレッド一覧ページへ遷移できること。

### 3.3 スレッド一覧表示（板ページ）

- **FR-020**：板ページでは、その板に属するスレッドを一覧表示すること。
- **FR-021**：スレッド一覧の各行には、少なくとも以下の情報を表示すること。
  - スレッドタイトル
  - スレッド作成日時
  - 最新書き込み日時
  - 投稿数（レス数）
- **FR-022**：スレッド一覧は、デフォルトで「最新書き込み日時」の降順で表示すること。
- **FR-023**：スレッド一覧はページングを行い、1ページあたりの表示件数を制限できること（例：50件）。

### 3.4 スレッド閲覧（スレッド詳細ページ）

- **FR-030**：スレッド詳細ページでは、スレッドタイトルと投稿一覧を表示すること。
- **FR-031**：各投稿には少なくとも以下の情報を表示すること。
  - 投稿番号（通し番号）
  - 投稿者名（例：「名無しさん」）
  - 投稿日時
  - 本文
- **FR-032**：投稿一覧は投稿番号の昇順で表示すること。
- **FR-033**：投稿数が一定数を超える場合、ページングまたは「古いレスを省略」を行う機能を設けること。
- **FR-034**：スレッド URL は固有であり、直接アクセス可能なこと。

### 3.5 スレッド作成

- **FR-040**：ユーザーは板ページから新規スレッドを作成できること。
- **FR-041**：スレッド作成フォームには以下の入力項目を設けること。
  - スレッドタイトル（必須）
  - 投稿本文（スレッドの1レス目、必須）
  - 投稿者名（任意：未入力の場合は「名無しさん」など）
- **FR-042**：必須項目が未入力の場合はエラーメッセージを表示し、登録を行わないこと。
- **FR-043**：スレッド作成後は、作成されたスレッド詳細ページへリダイレクトすること。

### 3.6 レス（返信）投稿

- **FR-050**：ユーザーはスレッド詳細ページからレスを投稿できること。
- **FR-051**：レス投稿フォームには以下の入力項目を設けること。
  - 投稿本文（必須）
  - 投稿者名（任意：未入力の場合は「名無しさん」）
- **FR-052**：投稿本文が空の場合は、エラーメッセージを表示し、投稿処理を行わないこと。
- **FR-053**：投稿成功時は、スレッド詳細ページにリダイレクトし、投稿が反映されていることを確認できること。
- **FR-054**：投稿直後に「投稿が完了しました」などの簡易メッセージを表示すること。

### 3.7 投稿内容の制限・バリデーション

- **FR-060**：投稿文字数に上限を設けること（例：本文 2,000 文字まで）。
- **FR-061**：連続投稿（スパム）対策として、同一 IP からの短時間の連続投稿を制限できること（例：5 秒以内の連投禁止）。
- **FR-062**：禁止ワード（NG ワード）リストを持ち、該当語が含まれている場合は投稿を拒否または伏字化できること（仕様は後述）。
- **FR-063**：HTML タグやスクリプトはエスケープして表示し、XSS を防止すること。

### 3.8 検索機能

- **FR-070**：ユーザーは以下の条件で検索できること。
  - スレッドタイトル検索
  - 投稿本文全文検索（実装可能であれば）
- **FR-071**：検索結果画面には、条件に一致したスレッドまたは投稿が一覧で表示されること。
- **FR-072**：検索結果から該当スレッド詳細ページへ遷移できること。

### 3.9 表示オプション

- **FR-080**：スレッド詳細ページで「最新レスから表示」「古いレスを省略」などの表示切替ができること（任意）。
- **FR-081**：1ページあたりの表示レス数を変更する簡易オプションを提供してもよい（例：20件 / 50件）。

### 3.10 報告（通報）機能（任意だが推奨）

- **FR-090**：ユーザーは、問題のある投稿に対して「通報」ボタンを押せること。
- **FR-091**：通報された投稿は管理画面で一覧閲覧できること（管理者機能参照）。
- **FR-092**：通報時に簡単な理由（選択式＋自由入力）を送信できること。

---

## 4. 管理者機能要件

### 4.1 管理者認証

- **FR-100**：管理者専用のログイン画面を提供すること。
- **FR-101**：ID / パスワードによる認証を行うこと。
- **FR-102**：ログイン状態は一定時間でタイムアウトすること。

### 4.2 板管理

- **FR-110**：管理者は以下の操作を行えること。
  - 新規板の追加
  - 既存板の編集（板名、説明文など）
  - 板の削除（論理削除推奨）
- **FR-111**：板の並び順を管理画面から変更できること。

### 4.3 スレッド管理

- **FR-120**：管理者はスレッド一覧を閲覧できること（板ごと、全体など）。
- **FR-121**：管理者は以下のスレッド操作を行えること。
  - スレッドの削除（論理削除）
  - スレッドのロック（新規レス投稿禁止）
  - スレッドタイトルの編集（任意）
- **FR-122**：削除されたスレッドは、一般ユーザー画面からは表示されないこと。

### 4.4 投稿管理

- **FR-130**：管理者は投稿一覧（またはスレッド単位の投稿一覧）を閲覧できること。
- **FR-131**：管理者は以下の投稿操作を行えること。
  - 投稿の削除
  - 投稿本文の一部マスク（任意）
- **FR-132**：削除された投稿は一般ユーザーからは見えないか、「削除済み」と表示されること。

### 4.5 通報管理

- **FR-140**：通報された投稿を一覧表示できること。
- **FR-141**：通報内容（投稿 ID、通報理由、通報日時など）を確認できること。
- **FR-142**：通報画面から、該当投稿を開き、削除・放置・保留などの対応ステータスを設定できること。

### 4.6 NG ワード・スパム対策設定

- **FR-150**：管理者は NG ワードリストを編集できること（追加・削除）。
- **FR-151**：NG ワードにヒットした場合の動作を設定できること。
  - 投稿拒否（エラーメッセージ）
  - 自動伏字化（例：「***」に置換）
- **FR-152**：IP ベースでのアクセス制限・投稿制限（BAN）設定ができること（任意）。

---

## 5. ログ・監査機能

- **FR-160**：以下の情報をログとして保存できること。
  - スレッド作成時の日時・IP・UserAgent
  - 投稿作成時の日時・IP・UserAgent
  - 管理者のログイン履歴
  - 管理者による削除・編集操作履歴
- **FR-161**：ログは管理画面から参照できるか、もしくは運用者がサーバログとして取得できること。

---

## 6. 非機能要件（簡易）

※質問は「機能要件」ですが、最低限あると設計しやすいので簡単に添えています。

- **NFR-001**：同時アクセス数 XX 件（後で決定）を想定し、一定のレスポンス性能を保つこと。
- **NFR-002**：投稿データ・スレッドデータは DB に永続化すること。
- **NFR-003**：XSS / CSRF / SQL インジェクション等、一般的な Web セキュリティ対策を行うこと。
- **NFR-004**：スマホ・PC いずれでも閲覧・投稿が可能なレスポンシブデザインとすること。

---

## 補足事項

### データ構造（例）

以下は想定されるデータベーステーブルの概要です：

#### 板（Boards）テーブル
- `id`: 板ID（主キー）
- `name`: 板名
- `description`: 説明文
- `order`: 表示順
- `created_at`: 作成日時
- `is_deleted`: 削除フラグ

#### スレッド（Threads）テーブル
- `id`: スレッドID（主キー）
- `board_id`: 所属板ID（外部キー）
- `title`: スレッドタイトル
- `created_at`: 作成日時
- `updated_at`: 最終更新日時
- `post_count`: 投稿数
- `is_locked`: ロックフラグ
- `is_deleted`: 削除フラグ
- `creator_ip_hash`: 作成者IPハッシュ

#### 投稿（Posts）テーブル
- `id`: 投稿ID（主キー）
- `thread_id`: スレッドID（外部キー）
- `post_number`: 投稿番号（スレッド内通し番号）
- `author_name`: 投稿者名
- `content`: 本文
- `created_at`: 投稿日時
- `ip_hash`: IPハッシュ
- `user_agent`: UserAgent
- `is_deleted`: 削除フラグ

#### 通報（Reports）テーブル
- `id`: 通報ID（主キー）
- `post_id`: 投稿ID（外部キー）
- `reason_type`: 通報理由タイプ
- `reason_text`: 通報理由（自由記述）
- `created_at`: 通報日時
- `status`: 対応ステータス（未対応/対応済/保留）
- `reporter_ip_hash`: 通報者IPハッシュ

#### NGワード（NgWords）テーブル
- `id`: NGワードID（主キー）
- `word`: NGワード
- `action`: アクション（reject/mask）
- `created_at`: 登録日時

#### IP制限（IpBans）テーブル
- `id`: 制限ID（主キー）
- `ip_hash`: IPハッシュ
- `reason`: 制限理由
- `created_at`: 制限開始日時
- `expires_at`: 制限終了日時（NULL=無期限）

#### 管理者（Admins）テーブル
- `id`: 管理者ID（主キー）
- `username`: ユーザー名
- `password_hash`: パスワードハッシュ
- `created_at`: 作成日時

### セキュリティ対策

1. **XSS対策**
   - ユーザー入力は全てエスケープ処理
   - HTMLタグは無効化

2. **CSRF対策**
   - トークンによる検証

3. **SQLインジェクション対策**
   - プリペアドステートメントの使用

4. **スパム対策**
   - 同一IPからの連続投稿制限
   - NGワードフィルタリング
   - IP BAN機能

5. **プライバシー保護**
   - IPアドレスはハッシュ化して保存
   - 個人情報は画面に表示しない

### 推奨技術スタック

#### フロントエンド
- HTML5 / CSS3
- JavaScript（Vanilla or 軽量フレームワーク）
- レスポンシブデザイン対応

#### バックエンド（例）
- **言語**: Python（Flask/Django）、Node.js（Express）、Ruby（Rails）、PHP など
- **データベース**: PostgreSQL、MySQL
- **キャッシュ**: Redis（オプション）

#### インフラ
- Webサーバー: Nginx / Apache
- ホスティング: VPS / クラウド（AWS, GCP, Azure等）

---

この仕様書は、5ch風匿名掲示板システム「AnonBBS」の実装に必要な機能要件を網羅しています。実装フェーズでは、優先順位をつけて段階的に開発を進めることを推奨します。

---

## 7. ローカル動作確認用シンプル実装案（MVP版）

以下は、Next.js + SQLite を使った最小構成の実装例です。ローカル環境で素早く動作確認できるように設計しています。

### 7.1 全体構成（ディレクトリ構造）

```
my-bbs/
  pages/
    index.tsx                 // スレッド一覧 + 新規スレッド作成
    threads/
      [id].tsx                // スレッド詳細 + レス投稿
    api/
      threads/
        index.ts              // GET: 全スレッド一覧 / POST: スレッド作成
      posts/
        [threadId].ts         // GET: 特定スレッドの投稿一覧 / POST: レス投稿
  lib/
    db.ts                     // sqlite 接続 & 初期化
    types.ts                  // Thread / Post 型
  components/
    layout/
      MainLayout.tsx          // 共通レイアウト
    threads/
      ThreadList.tsx
      ThreadForm.tsx
      PostList.tsx
      PostForm.tsx
  public/
  styles/
    globals.css               // Tailwind
  tailwind.config.js
  tsconfig.json
  package.json
  bbs.sqlite                  // sqlite DB ファイル（自動生成）
```

### 7.2 データベース（SQLite）

#### 7.2.1 テーブル定義（SQL）

MVP版として、最小限の2テーブル構成：

```sql
CREATE TABLE IF NOT EXISTS threads (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  author TEXT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  thread_id INTEGER NOT NULL,
  author TEXT NOT NULL,
  body TEXT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY(thread_id) REFERENCES threads(id) ON DELETE CASCADE
);
```

### 7.3 SQLite接続ヘルパー（lib/db.ts）

`better-sqlite3` を使用した接続管理：

```typescript
// lib/db.ts
import Database from 'better-sqlite3';
import path from 'path';

const dbPath = path.join(process.cwd(), 'bbs.sqlite');
const db = new Database(dbPath);

// 初回起動時にテーブルを作成
db.exec(`
CREATE TABLE IF NOT EXISTS threads (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  author TEXT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  thread_id INTEGER NOT NULL,
  author TEXT NOT NULL,
  body TEXT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY(thread_id) REFERENCES threads(id) ON DELETE CASCADE
);
`);

export default db;
```

### 7.4 TypeScript型定義（lib/types.ts）

```typescript
// lib/types.ts
export type Thread = {
  id: number;
  title: string;
  author: string;
  created_at: string;
};

export type Post = {
  id: number;
  thread_id: number;
  author: string;
  body: string;
  created_at: string;
};
```

### 7.5 APIルート

#### 7.5.1 スレッド一覧 & 作成（pages/api/threads/index.ts）

```typescript
// pages/api/threads/index.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import db from '@/lib/db';
import type { Thread } from '@/lib/types';

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method === 'GET') {
    const stmt = db.prepare<Thread>('SELECT * FROM threads ORDER BY created_at DESC');
    const threads = stmt.all();
    return res.status(200).json(threads);
  }

  if (req.method === 'POST') {
    const { title, author } = req.body as { title?: string; author?: string };
    
    if (!title || title.trim() === '') {
      return res.status(400).json({ message: 'タイトルは必須です' });
    }

    const safeAuthor = author && author.trim() !== '' ? author.trim() : '名無しさん';

    const insert = db.prepare(
      'INSERT INTO threads (title, author) VALUES (?, ?)'
    );
    const result = insert.run(title.trim(), safeAuthor);

    const thread = db
      .prepare<Thread>('SELECT * FROM threads WHERE id = ?')
      .get(result.lastInsertRowid);

    return res.status(201).json(thread);
  }

  res.setHeader('Allow', ['GET', 'POST']);
  return res.status(405).end('Method Not Allowed');
}
```

#### 7.5.2 投稿一覧 & 作成（pages/api/posts/[threadId].ts）

```typescript
// pages/api/posts/[threadId].ts
import type { NextApiRequest, NextApiResponse } from 'next';
import db from '@/lib/db';
import type { Post } from '@/lib/types';

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const threadId = Number(req.query.threadId);
  
  if (Number.isNaN(threadId)) {
    return res.status(400).json({ message: 'threadId が不正です' });
  }

  if (req.method === 'GET') {
    const stmt = db.prepare<Post>(
      'SELECT * FROM posts WHERE thread_id = ? ORDER BY created_at ASC'
    );
    const posts = stmt.all(threadId);
    return res.status(200).json(posts);
  }

  if (req.method === 'POST') {
    const { body, author } = req.body as { body?: string; author?: string };
    
    if (!body || body.trim() === '') {
      return res.status(400).json({ message: '本文は必須です' });
    }

    const safeAuthor = author && author.trim() !== '' ? author.trim() : '名無しさん';

    const insert = db.prepare(
      'INSERT INTO posts (thread_id, author, body) VALUES (?, ?, ?)'
    );
    insert.run(threadId, safeAuthor, body.trim());

    const stmt = db.prepare<Post>(
      'SELECT * FROM posts WHERE thread_id = ? ORDER BY created_at ASC'
    );
    const posts = stmt.all(threadId);

    return res.status(201).json(posts);
  }

  res.setHeader('Allow', ['GET', 'POST']);
  return res.status(405).end('Method Not Allowed');
}
```

### 7.6 フロントエンド（Pages Router）

#### 7.6.1 共通レイアウト（components/layout/MainLayout.tsx）

shadcn/ui + Lucide + Framer Motion を使用：

```typescript
// components/layout/MainLayout.tsx
import { ReactNode } from 'react';
import { motion } from 'framer-motion';
import { MessageCircle } from 'lucide-react';

type Props = {
  children: ReactNode;
};

export const MainLayout: React.FC<Props> = ({ children }) => {
  return (
    <div className="min-h-screen bg-slate-950 text-slate-100">
      <header className="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
        <div className="mx-auto flex max-w-4xl items-center gap-2 px-4 py-3">
          <motion.div
            initial={{ rotate: -10, scale: 0.8 }}
            animate={{ rotate: 0, scale: 1 }}
            transition={{ type: 'spring', stiffness: 260, damping: 18 }}
            className="rounded-full bg-sky-500/10 p-2"
          >
            <MessageCircle className="h-6 w-6" />
          </motion.div>
          <div>
            <h1 className="text-lg font-semibold">匿名掲示板</h1>
            <p className="text-xs text-slate-400">会員登録なしで使える簡易BBS</p>
          </div>
        </div>
      </header>
      <main className="mx-auto max-w-4xl px-4 py-6">{children}</main>
    </div>
  );
};
```

#### 7.6.2 スレッド一覧ページ（pages/index.tsx）

```typescript
// pages/index.tsx
import useSWR from 'swr';
import { useState } from 'react';
import { MainLayout } from '@/components/layout/MainLayout';
import { Thread } from '@/lib/types';
import { motion } from 'framer-motion';
import Link from 'next/link';
import { Plus, ArrowRight } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

const fetcher = (url: string) => fetch(url).then((r) => r.json());

export default function IndexPage() {
  const { data: threads, mutate } = useSWR<Thread[]>('/api/threads', fetcher);
  const [title, setTitle] = useState('');
  const [author, setAuthor] = useState('');

  const handleCreateThread = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title.trim()) return;

    await fetch('/api/threads', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, author }),
    });

    setTitle('');
    // 作者は残してもいいのでそのまま
    mutate();
  };

  return (
    <MainLayout>
      <div className="grid gap-6 md:grid-cols-[2fr,1.5fr]">
        {/* スレッド一覧 */}
        <section className="space-y-3">
          <h2 className="flex items-center justify-between text-sm font-semibold text-slate-200">
            <span>スレッド一覧</span>
          </h2>
          <div className="space-y-3">
            {threads && threads.length > 0 ? (
              threads.map((thread) => (
                <motion.div
                  key={thread.id}
                  initial={{ opacity: 0, y: 4 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.15 }}
                >
                  <Card className="border-slate-800 bg-slate-900/70 hover:border-sky-500/60">
                    <CardHeader className="flex flex-row items-center justify-between space-y-0">
                      <CardTitle className="line-clamp-1 text-sm font-medium">
                        <Link href={`/threads/${thread.id}`}>
                          {thread.title}
                        </Link>
                      </CardTitle>
                      <Button
                        asChild
                        variant="ghost"
                        size="icon"
                        className="h-7 w-7 text-slate-400 hover:text-sky-400"
                      >
                        <Link href={`/threads/${thread.id}`}>
                          <ArrowRight className="h-4 w-4" />
                        </Link>
                      </Button>
                    </CardHeader>
                    <CardContent className="flex items-center justify-between text-xs text-slate-400">
                      <span>スレ主: {thread.author}</span>
                      <span>
                        {new Date(thread.created_at).toLocaleString('ja-JP')}
                      </span>
                    </CardContent>
                  </Card>
                </motion.div>
              ))
            ) : (
              <p className="text-xs text-slate-500">
                まだスレッドがありません。右側のフォームから作成できます。
              </p>
            )}
          </div>
        </section>

        {/* 新規スレッド作成フォーム */}
        <section className="space-y-3">
          <h2 className="flex items-center gap-2 text-sm font-semibold text-slate-200">
            <Plus className="h-4 w-4" />
            新規スレッド作成
          </h2>
          <Card className="border-slate-800 bg-slate-900/80">
            <CardContent className="pt-4">
              <form onSubmit={handleCreateThread} className="space-y-3">
                <div className="space-y-1.5">
                  <label className="text-xs text-slate-300">スレッドタイトル *</label>
                  <Input
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    placeholder="例）今日あったことを雑談するスレ"
                    className="bg-slate-950/60 text-sm"
                  />
                </div>
                <div className="space-y-1.5">
                  <label className="text-xs text-slate-300">
                    名前（省略可・未入力は「名無しさん」）
                  </label>
                  <Input
                    value={author}
                    onChange={(e) => setAuthor(e.target.value)}
                    placeholder="例）あんのんさん"
                    className="bg-slate-950/60 text-sm"
                  />
                </div>
                <Button type="submit" className="w-full gap-1 text-sm">
                  <Plus className="h-4 w-4" />
                  スレッドを立てる
                </Button>
              </form>
            </CardContent>
          </Card>
        </section>
      </div>
    </MainLayout>
  );
}
```

> **注記**: MVP簡略化のため、スレッドの1レス目の本文は「スレッド詳細ページ」で投稿する方式を採用しています。必要に応じて、スレッド作成時に「最初の本文」も一緒に送るよう拡張できます。

#### 7.6.3 スレッド詳細ページ（pages/threads/[id].tsx）

```typescript
// pages/threads/[id].tsx
import { useRouter } from 'next/router';
import useSWR from 'swr';
import { useState } from 'react';
import { MainLayout } from '@/components/layout/MainLayout';
import type { Thread, Post } from '@/lib/types';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { motion } from 'framer-motion';

const fetcher = (url: string) => fetch(url).then((r) => r.json());

export default function ThreadPage() {
  const router = useRouter();
  const id = router.query.id as string | undefined;

  const { data: threads } = useSWR<Thread[]>('/api/threads', fetcher);
  const thread = threads?.find((t) => t.id === Number(id));

  const { data: posts, mutate } = useSWR<Post[]>(
    id ? `/api/posts/${id}` : null,
    fetcher
  );

  const [author, setAuthor] = useState('');
  const [body, setBody] = useState('');

  const handlePost = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!id || !body.trim()) return;

    await fetch(`/api/posts/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ body, author }),
    });

    setBody('');
    mutate();
  };

  if (!id) {
    return null;
  }

  return (
    <MainLayout>
      <div className="space-y-4">
        {thread && (
          <Card className="border-slate-800 bg-slate-900/80">
            <CardHeader>
              <CardTitle className="text-base">{thread.title}</CardTitle>
              <p className="mt-1 text-xs text-slate-400">
                スレ主: {thread.author} /{' '}
                {new Date(thread.created_at).toLocaleString('ja-JP')}
              </p>
            </CardHeader>
          </Card>
        )}

        {/* 投稿一覧 */}
        <section className="space-y-2">
          <h2 className="text-sm font-semibold text-slate-200">レス一覧</h2>
          <div className="space-y-2">
            {posts && posts.length > 0 ? (
              posts.map((post, index) => (
                <motion.div
                  key={post.id}
                  initial={{ opacity: 0, y: 2 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.12 }}
                >
                  <Card className="border-slate-800 bg-slate-950/70">
                    <CardContent className="pt-3">
                      <div className="flex items-baseline justify-between text-xs text-slate-400">
                        <span>
                          {index + 1} 名前：{post.author}
                        </span>
                        <span>
                          {new Date(post.created_at).toLocaleString('ja-JP')}
                        </span>
                      </div>
                      <p className="mt-2 whitespace-pre-wrap text-sm text-slate-100">
                        {post.body}
                      </p>
                    </CardContent>
                  </Card>
                </motion.div>
              ))
            ) : (
              <p className="text-xs text-slate-500">まだレスがありません。</p>
            )}
          </div>
        </section>

        {/* レス投稿フォーム */}
        <section className="space-y-2">
          <h2 className="text-sm font-semibold text-slate-200">
            レスを書く
          </h2>
          <Card className="border-slate-800 bg-slate-900/80">
            <CardContent className="pt-4">
              <form onSubmit={handlePost} className="space-y-3">
                <div className="space-y-1.5">
                  <label className="text-xs text-slate-300">
                    名前（省略可・未入力は「名無しさん」）
                  </label>
                  <Input
                    value={author}
                    onChange={(e) => setAuthor(e.target.value)}
                    placeholder="例）通りすがり"
                    className="bg-slate-950/60 text-sm"
                  />
                </div>
                <div className="space-y-1.5">
                  <label className="text-xs text-slate-300">本文 *</label>
                  <Textarea
                    value={body}
                    onChange={(e) => setBody(e.target.value)}
                    rows={4}
                    placeholder="ここにレス内容を書いてください"
                    className="bg-slate-950/60 text-sm"
                  />
                </div>
                <Button type="submit" className="w-full text-sm">
                  投稿する
                </Button>
              </form>
            </CardContent>
          </Card>
        </section>
      </div>
    </MainLayout>
  );
}
```

### 7.7 必要なパッケージ

```json
{
  "dependencies": {
    "next": "^14.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "better-sqlite3": "^9.0.0",
    "swr": "^2.2.0",
    "framer-motion": "^10.0.0",
    "lucide-react": "^0.300.0",
    "@radix-ui/react-slot": "^1.0.0",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.0.0",
    "tailwind-merge": "^2.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^18.2.0",
    "@types/better-sqlite3": "^7.6.0",
    "typescript": "^5.0.0",
    "tailwindcss": "^3.3.0",
    "autoprefixer": "^10.4.0",
    "postcss": "^8.4.0"
  }
}
```

### 7.8 セットアップ手順

1. プロジェクトの作成

```bash
npx create-next-app@latest my-bbs --typescript --tailwind --app false
cd my-bbs
```

2. 必要なパッケージのインストール

```bash
npm install better-sqlite3 swr framer-motion lucide-react
npm install -D @types/better-sqlite3
```

3. shadcn/ui の初期化とコンポーネント追加

```bash
npx shadcn-ui@latest init
npx shadcn-ui@latest add button input textarea card
```

4. 開発サーバーの起動

```bash
npm run dev
```

5. ブラウザで `http://localhost:3000` にアクセス

### 7.9 今後の拡張ポイント

この MVP実装をベースに、以下の機能を段階的に追加できます：

1. **板（カテゴリ）機能の追加**
   - `boards` テーブルの追加
   - 板ごとのスレッド管理

2. **管理者機能の実装**
   - 認証システム（NextAuth.js など）
   - 管理画面の構築
   - 削除・ロック機能

3. **セキュリティ強化**
   - IP制限機能
   - NGワードフィルタ
   - 連続投稿制限
   - CSRF対策

4. **検索機能の追加**
   - 全文検索の実装
   - SQLite FTS5 の活用

5. **通報機能の実装**
   - 通報テーブルの追加
   - 管理画面での通報管理

6. **UI/UX改善**
   - ページネーション
   - リアルタイム更新
   - モバイル最適化

---

## まとめ

本仕様書では、5ch風匿名掲示板システム「AnonBBS」の完全な機能要件と、ローカル環境で素早く動作確認できるシンプルな実装案を提供しました。MVP版から始めて、段階的に機能を拡張していくアプローチを推奨します。

